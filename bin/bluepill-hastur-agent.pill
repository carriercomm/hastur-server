# hastur-agent bluepill
require 'hastur-server/ooyala_config'

# Other sites should replace this with their own list, either by
# creating a custom Hastur::MyConfig or just by setting ROUTERS
# to a list of ZeroMQ URIs.
ROUTERS = Hastur::OoyalaConfig.get_routers

# modern Linux boxes use /run
if File.directory? "/run"
  PIDFILE = "/run/hastur-agent.pid"
else
  PIDFILE = "/var/run/hastur-agent.pid"
end

# If we don't specify a log file, we get syslog logging to LOCAL6 by default.
Bluepill.application("hastur_agent") do |app|
  app.process("hastur_agent") do |process|
    process.environment = {
      "PATH" => "/opt/hastur/bin:/opt/local/bin:/usr/local/bin:/usr/local/sbin:/bin:/usr/bin:/sbin:/usr/sbin",
      "LD_LIBRARY_PATH" => "/opt/hastur/lib",
    }
    process.start_command = "/opt/hastur/bin/hastur-agent.rb #{ROUTERS.join(' ')}"
    process.stop_signals = [:quit, 15.seconds, :term, 5.seconds, :kill]
    process.working_dir = "/"
    process.pid_file = PIDFILE
    process.uid = "role-hastur"
    process.gid = "role-hastur"
    process.daemonize = true
    process.start_grace_time = 5.seconds
    process.stop_grace_time = 30.seconds
    process.restart_grace_time = 45.seconds
    process.checks :mem_usage, :every => 120.seconds, :below => 100.megabytes, :times => [3,5]
    process.checks :flapping, :times => 2, :within => 30.seconds, :retry_in => 15.seconds
  end
end

# vim: ft=ruby
