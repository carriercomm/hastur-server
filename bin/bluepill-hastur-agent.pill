# hastur-agent bluepill
require 'hastur-server/ooyala_config'
require 'fileutils'

NO_PRIVILEGE = Process.uid != 0

# Other sites should replace this with their own list, either by
# creating a custom Hastur::MyConfig or just by setting ROUTERS
# to a list of ZeroMQ URIs.
ROUTERS = Hastur::OoyalaConfig.get_routers

if NO_PRIVILEGE
  # If you're not root and running --no-privileged, put pids in /tmp/hastur
  RUNDIR="/tmp/hastur"
elsif File.directory? "/run"
  # modern Linux boxes use /run
  RUNDIR="/run/hastur"
else
  RUNDIR="/var/run/hastur"
end
FileUtils.mkdir_p RUNDIR
FileUtils.chown 'role-hastur', 'role-hastur', RUNDIR unless NO_PRIVILEGE

hastur_dir = NO_PRIVILEGE ? File.expand_path(".") : "/opt/hastur"

# If we don't specify a log file, we get syslog logging to LOCAL6 by default.
Bluepill.application("hastur_agent") do |app|
  app.process("hastur_agent") do |process|
    process.environment = {
      "PATH" => "#{hastur_dir}/bin:/opt/local/bin:/usr/local/bin:/usr/local/sbin:/bin:/usr/bin:/sbin:/usr/sbin",
      "LD_LIBRARY_PATH" => "/opt/hastur/lib",
    }
    process.start_command = "#{hastur_dir}/bin/hastur-agent.rb #{ROUTERS.map { |r| "--router #{r}" }.join(' ')}"
    process.stop_signals = [:quit, 15.seconds, :term, 5.seconds, :kill]
    process.working_dir = "/"
    process.pid_file = "#{RUNDIR}/hastur-agent.pid"
    process.uid = "role-hastur" unless NO_PRIVILEGE
    process.gid = "role-hastur" unless NO_PRIVILEGE
    process.daemonize = true
    process.start_grace_time = 5.seconds
    process.stop_grace_time = 30.seconds
    process.restart_grace_time = 45.seconds
    process.checks :mem_usage, :every => 120.seconds, :below => 100.megabytes, :times => [3,5]
    process.checks :flapping, :times => 2, :within => 30.seconds, :retry_in => 15.seconds
  end
end

# vim: ft=ruby
